<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchases Form</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        form {
            max-width: 600px;
            margin: auto;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 15px;
            margin-top: 10px;
        }
        .items-list, .available-items {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Create Purchase Order</h1>
    <form id="purchaseForm">

        <div id="itemsContainer">
            <div class="form-group">
                <label for="itemInput">Item Name:</label>
                <input type="text" id="itemInput" name="itemInput" required>
                <div id="itemValidation" style="color: red;"></div>
            </div>
            <div class="form-group">
                <label for="quantityInput">Quantity:</label>
                <input type="number" id="quantityInput" name="quantityInput" required>
            </div>
        </div>
        <div class="form-group">
            <label>
                <input type="checkbox" id="autoCreateDelivery" name="autoCreateDelivery"> Auto Create Delivery
                <input type="checkbox" id="autoCreateInvoice" name="autoCreateInvoice"> Auto Create Invoice
                <input type="checkbox" id="autoCreatePay" name="autoCreatePay"> Auto Create Payment
            </label>
        </div>
        <button type="button" onclick="addItem()">Add Another Item</button>
        <button type="submit">Submit Purchase Order</button>
    </form>
    <div class="available-items">
        <h2>Available Items</h2>
        <ul id="availableItemsList"></ul>
    </div>
    <div class="items-list">
        <h2>Items List</h2>
        <ul id="itemsList"></ul>
        <p>Total Price: <span id="totalPrice">0</span></p>
    </div>
<script>
    let items = [];
    let availableItems = [];
    let totalPrice = 0;

    // Fetch available items on page load
    window.onload = function() {
        fetch('http://localhost:5000/items')
            .then(response => response.json())
            .then(data => {
                availableItems = data;
                console.log('Available items:', availableItems);
                displayAvailableItems();
            })
            .catch(error => console.error('Error fetching items:', error));
    };

    function displayAvailableItems() {
        const availableItemsList = document.getElementById('availableItemsList');
        availableItemsList.innerHTML = '';
        availableItems.forEach(item => {
            const li = document.createElement('li');
            li.textContent = `Item: ${item.ItemName}, Code: ${item.ItemCode}, Price: ${item.Price}`;
            availableItemsList.appendChild(li);
        });
    }

    function validateItem() {
        const itemInput = document.getElementById('itemInput').value.trim().toLowerCase();
        const item = availableItems.find(item => item.ItemCode.toLowerCase() === itemInput || item.ItemName.toLowerCase() === itemInput);
        const itemValidation = document.getElementById('itemValidation');
        if (item) {
            itemValidation.textContent = '';
        } else {
            itemValidation.textContent = 'Item not found';
        }
    }

    function addItem() {
        const itemInput = document.getElementById('itemInput').value.trim().toLowerCase();
        const quantityInput = parseFloat(document.getElementById('quantityInput').value);
        const item = availableItems.find(item => item.ItemCode.toLowerCase() === itemInput || item.ItemName.toLowerCase() === itemInput);
        validateItem();

        if (item && quantityInput) {
            const totalItemPrice = item.Price * quantityInput;
            items.push({ item: itemInput, quantity: quantityInput, totalItemPrice });
            const itemsList = document.getElementById('itemsList');
            const li = document.createElement('li');
            li.textContent = `Item: ${item.ItemName}, Quantity: ${quantityInput}, Total Price: ${totalItemPrice.toFixed(2)}`;
            itemsList.appendChild(li);
            updateTotalPrice();
        }
    }

    function updateTotalPrice() {
        totalPrice = items.reduce((acc, curr) => acc + curr.totalItemPrice, 0);
        document.getElementById('totalPrice').textContent = totalPrice.toFixed(2);
    }

    document.getElementById('itemInput').addEventListener('blur', validateItem);

document.getElementById('purchaseForm').addEventListener('submit', async function(event) {
    event.preventDefault();

    const autoCreateDelivery = document.getElementById('autoCreateDelivery').checked;
    const autoCreateInvoice = document.getElementById('autoCreateInvoice').checked;
    const autoCreatePay = document.getElementById('autoCreatePay').checked;

    const payload = {
        items: items
    };

    try {
        const response = await fetch('http://localhost:5000/purchase_order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (Array.isArray(data) && data.length > 0) {
            data.forEach(order => {
                if (order.DocEntry) {
                    alert(`Purchase Order Created! DocEntry: ${order.DocEntry}`);
                } else {
                    alert(`Error creating purchase order: ${order.message}`);
                }
            });

            let deliveryData = [];

            if (autoCreateDelivery) {
                deliveryData = data.map(order => ({
                    CardCode: order.CardCode,
                    DocEntry: order.DocEntry,
                    DocumentLines: order.DocumentLines,
                }));

                const deliveryResponse = await fetch('http://localhost:5000/goods_receipt_po', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(deliveryData)
                });

                const deliveryResult = await deliveryResponse.json();
                deliveryResult.forEach(delivery => {
                    if (delivery.DocEntry) {
                        alert(`Delivery Created! DocEntry: ${delivery.DocEntry}`);
                    } else {
                        alert(`Error creating delivery: ${delivery.message}`);
                    }
                });
            }

            let invoiceData = [];

            if (autoCreateInvoice) {
                invoiceData = deliveryData.map(delivery => ({
                    CardCode: delivery.CardCode,
                    DocumentLines: delivery.DocumentLines,
                }));

                const invoiceResponse = await fetch('http://localhost:5000/ap_invoice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(invoiceData)
                });

                const invoiceResult = await invoiceResponse.json();
                invoiceResult.forEach(invoice => {
                    if (invoice.DocEntry) {
                        alert(`Invoice Created! DocEntry: ${invoice.DocEntry}`);
                    } else {
                        alert(`Error creating invoice: ${invoice.message}`);
                    }
                });
            }

            let payData = [];

            if (autoCreatePay) {
                payData = invoiceData.map(invoice => ({
                    CardCode: invoice.CardCode,
                    DocEntry: invoice.DocEntry,
                    DocumentLines: invoice.DocumentLines
                }));

                const payResponse = await fetch('http://localhost:5000/payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payData)
                });

                const payResult = await payResponse.json();
                payResult.forEach(payment => {
                    if (payment.DocEntry) {
                        alert(`Payment Created! DocEntry: ${payment.DocEntry}`);
                    } else {
                        alert(`Error creating payment: ${payment.message}`);
                    }
                });
            }
        } else {
            alert('No purchase orders were created.');
        }
    } catch (error) {
        console.error('Error creating purchase order:', error);
    }
});

</script>

</body>
</html>
